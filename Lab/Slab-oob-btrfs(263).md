# slab-out-of-bounds in __btrfs_map_block+0x4e2/0x1980

```c
pwndbg> b *__btrfs_map_block+0x4e2
Breakpoint 1 at 0xffffffff816a78c2: file fs/btrfs/volumes.c, line 6248.
```
<br>

```c
pwndbg> list *__btrfs_map_block+0x4e2
0xffffffff816a78c2 is in __btrfs_map_block (fs/btrfs/volumes.c:6248).
6243			for (i = 0; i < nr_data_stripes(map); i++)
6244				bbio->raid_map[(i+rot) % num_stripes] =
6245					em->start + (tmp + i) * map->stripe_len;
6246
6247			bbio->raid_map[(i+rot) % map->num_stripes] = RAID5_P_STRIPE;
6248			if (map->type & BTRFS_BLOCK_GROUP_RAID6)
6249				bbio->raid_map[(i+rot+1) % num_stripes] =
6250					RAID6_Q_STRIPE;
6251		}
```

`pwndbg> b *__btrfs_map_block+0x4e2`으로 설정했을시 kasan report가 나온뒤에 `break point`가 걸린다.<br>

```c
 ► f 0 ffffffff816a78bd __btrfs_map_block+1245
 ```
↕ 이 사이 지점에서 `KASAN REPORT`가 터지게된다.

 ```c
 ► f 0 ffffffff816a78c2 __btrfs_map_block+1250
 ```
<br>

 ```c
 [  448.452651] The buggy address belongs to the object at ffff88806a574d80
[  448.452651]  which belongs to the cache kmalloc-128 of size 128
[  448.452651] The buggy address is located 0 bytes to the right of
[  448.452651]  128-byte region [ffff88806a574d80, ffff88806a574e00)
[  448.452651] The buggy address belongs to the page:
[  448.452651] page:ffffea0001a95d00 count:1 mapcount:0 mapping:ffff88806d001640 index:0x0
```

 <br>

 ```c
 static int __btrfs_map_block(struct btrfs_fs_info *fs_info,
			     enum btrfs_map_op op,
			     u64 logical, u64 *length,
			     struct btrfs_bio **bbio_ret,
			     int mirror_num, int need_raid_map)
 ```
`rdi / rsi / rdx / rcx / r8 / r9 ` 순서대로 인자들이 레지스터에 들어가게 된다.<br>

```c
rdi = struct * fs_info // rsp + 0x58
rsi = enum op
rdx = u64 logical
rcx = u64 *length
r8 = struct **bbio_ret  // rsp_0x70
r9 = int mirror_num // rsp+0x60
stack = need_raid_map
 ```



 ```c
 for (i = 0; i < nr_data_stripes(map); i++)
   bbio->raid_map[(i+rot) % num_stripes] =
     em->start + (tmp + i) * map->stripe_len;
 ```
이 for문을 돌면서 crash가 터지는것 같다.<br>
for문의 i++에 `breakpoint`를 걸어보았는데 1번만 돌고 crash report가 발생한다.<br>


```c
for (i = 0; i < nr_data_stripes(map); i++)
  bbio->raid_map[(i+rot) % num_stripes] =
    em->start + (tmp + i) * map->stripe_len;
bbio->raid_map[(i+rot) % map->num_stripes] = RAID5_P_STRIPE; // KASAN here
 ```

`#define RAID5_P_STRIPE ((u64)-2)`를 보면 OOB되는 구간의 값이 -2로 설정되어 있다.<br>


```c
rdi = struct * fs_info // rsp + 0x58
rsi = enum op
rdx = u64 logical
rcx = u64 *length
r8 = struct **bbio_ret  // rsp_0x70
r9 = int mirror_num // rsp+0x60
stack = need_raid_map
 ```

```c
pwndbg> p *em
$1 = {
  rb_node = {
    __rb_parent_color = 1,
    rb_right = 0xffff88806bc2a270,
    rb_left = 0xffff88806bc2a1a0
  },
  start = 20971520,
  len = 8388608,
  mod_start = 20971520,
  mod_len = 8388608,
  orig_start = 0,
  orig_block_len = 0,
  ram_bytes = 0,
  block_start = 0,
  block_len = 8388608,
  generation = 0,
  flags = 32,
  {
    bdev = 0xffff88806bc19480,
    map_lookup = 0xffff88806bc19480
  },
  refs = {
    refs = {
      counter = 2
    }
  },
  compress_type = 0,
  list = {
    next = 0xffff88806bc2a080,
    prev = 0xffff88806bc2a080
  }
}


pwndbg> p *map
$4 = {
  type = 186,
  io_align = 65536,
  io_width = 65536,
  stripe_len = 65536,
  num_stripes = 2,
  sub_stripes = 0,
  verified_stripes = 2,
  stripes = 0xffff88806bc29da8
}

gef➤  p *map
$5 = {
  type = 0x1,
  io_align = 0x10000,
  io_width = 0x10000,
  stripe_len = 0x10000,
  num_stripes = 0x1,
  sub_stripes = 0x0,
  verified_stripes = 0x1,
  stripes = 0xffff88806a0aed48
}

 0xffffffff816a1b87 <__btrfs_map_block+1255>    mov    qword ptr [rbp], -2

 RBP  0xffff88806b13cd40 ◂— 0x986000ab00000727
 pwndbg> x/x 0xffff88806b13cd40
 0xffff88806b13cd40:	0x00000727
 ```

```c
for (i = 0; i < nr_data_stripes(map) /*1*/; i++)
```
```c
static inline int nr_data_stripes(struct map_lookup *map)
{
	return map->num_stripes - nr_parity_stripes(map);
}


static inline int nr_parity_stripes(struct map_lookup *map)
{
	if (map->type & BTRFS_BLOCK_GROUP_RAID5)
		return 1;
	else if (map->type & BTRFS_BLOCK_GROUP_RAID6)
		return 2;
	else
		return 0;
}

```
```c
gef➤  p *bio
$20 = {
  bi_next = 0x0 <irq_stack_union>,
  bi_disk = 0xffff88806aa59980,
  bi_opf = 0x1801,
  bi_flags = 0xc000,
  bi_ioprio = 0x0,
  bi_write_hint = 0x0,
  bi_status = 0x0,
  bi_partno = 0x0,
  bi_phys_segments = 0x0,
  bi_seg_front_size = 0x0,
  bi_seg_back_size = 0x0,
  bi_iter = {
    bi_sector = 0xa000,
    bi_size = 0x1000,
    bi_idx = 0x0,
    bi_bvec_done = 0x0
  },
  __bi_remaining = {
    counter = 0x1
  },
  bi_end_io = 0xffffffff8168ae20 <end_bio_extent_buffer_writepage>,
  bi_private = 0x0 <irq_stack_union>,
  {<No data fields>},
  bi_vcnt = 0x1,
  bi_max_vecs = 0x100,
  __bi_cnt = {
    counter = 0x1
  },
  bi_io_vec = 0xffff888069446600,
  bi_pool = 0xffffffff83e2a4a0 <btrfs_bioset>,
  bi_inline_vecs = 0xffff8880696758e0
}

gef➤  p logical
$22 = 0xa000

gef➤  p map_length
$24 = 0x1000

gef➤  p mirror_num
$28 = 0x0


gef➤  p *bbio
$35 = {
  refs = {
    refs = {
      counter = 0x1
    }
  },
  stripes_pending = {
    counter = 0x0
  },
  fs_info = 0xffff8880686d8000,
  map_type = 0xba,
  end_io = 0xffffffff8168ae20 ,
  orig_bio = 0xffff888069675870,
  flags = 0x0,
  private = 0x0 <irq_stack_union>,
  error = {
    counter = 0x0
  },
  max_errors = 0x1,
  num_stripes = 0x1,
  mirror_num = 0x0,
  num_tgtdevs = 0x0,
  tgtdev_map = 0x0 <irq_stack_union>,
  raid_map = 0xffff88806b08e438,
  stripes = 0xffff88806b08e420
}



```

```c
#0  nr_parity_stripes (map=<optimized out>) at fs/btrfs/raid56.h:12
#1  nr_data_stripes (map=<optimized out>) at fs/btrfs/raid56.h:22
#2  __btrfs_map_block (fs_info=<optimized out>, op=<optimized out>, logical=0x1400000, length=0xffff88806651f588, bbio_ret=<optimized out>, mirror_num=<optimized out>, need_raid_map=0x1) at fs/btrfs/volumes.c:6075
#3  0xffffffff816a37cf in btrfs_map_bio (fs_info=0xffff888067674400, bio=0xffff888066871570, mirror_num=0x0, async_submit=<optimized out>) at fs/btrfs/volumes.c:6560
#4  0xffffffff8164e592 in btree_submit_bio_hook (private_data=<optimized out>, bio=0xffff888066871570, mirror_num=0x0, bio_flags=<optimized out>, bio_offset=0x1400000) at fs/btrfs/disk-io.c:892
#5  0xffffffff8168ad59 in submit_one_bio (bio=0xffff888066871570, mirror_num=0x0, bio_flags=0x0) at fs/btrfs/extent_io.c:2709
#6  0xffffffff8168b2aa in flush_write_bio (epd=<optimized out>) at fs/btrfs/extent_io.c:4015
#7  0xffffffff81697014 in btree_write_cache_pages (mapping=<optimized out>, wbc=0xffff88806651f948) at fs/btrfs/extent_io.c:3844
#8  0xffffffff8123c54d in do_writepages (mapping=0xffff888064510388, wbc=0xffff88806651f948) at mm/page-writeback.c:2335
#9  0xffffffff81224eb8 in __filemap_fdatawrite_range (mapping=0xffff888064510388, start=<optimized out>, end=<optimized out>, sync_mode=<optimized out>) at mm/filemap.c:411
#10 0xffffffff81224fda in filemap_fdatawrite_range (mapping=<optimized out>, start=<optimized out>, end=<optimized out>) at mm/filemap.c:431
#11 0xffffffff81658f1d in btrfs_write_marked_extents (fs_info=0xffff888067674400, dirty_pages=0xffff888069f8af38, mark=0x1) at fs/btrfs/transaction.c:938
#12 0xffffffff8165901b in btrfs_write_and_wait_transaction (trans=<optimized out>, trans=<optimized out>) at fs/btrfs/transaction.c:1050
#13 0xffffffff8165b50b in btrfs_commit_transaction (trans=0xffff8880644840a8) at fs/btrfs/transaction.c:2261
#14 0xffffffff81650bbe in btrfs_commit_super (fs_info=<optimized out>) at fs/btrfs/disk-io.c:3952
#15 0xffffffff81653441 in close_ctree (fs_info=0xffff888067674400) at fs/btrfs/disk-io.c:3999
#16 0xffffffff812cd248 in generic_shutdown_super (sb=0xffff8880690fdd80) at fs/super.c:457
#17 0xffffffff812cd5e9 in kill_anon_super (sb=0xffff8880690fdd80) at fs/super.c:1033
#18 0xffffffff81609660 in btrfs_kill_super (sb=0xffff8880690fdd80) at fs/btrfs/super.c:2134
#19 0xffffffff812cd9e8 in deactivate_locked_super (s=0xffff8880690fdd80) at fs/super.c:330
#20 0xffffffff812cf1c2 in deactivate_super (s=0xffff8880690fdd80) at fs/super.c:361
#21 0xffffffff812ff1d7 in cleanup_mnt (mnt=0xffff88806746c700) at fs/namespace.c:1096
#22 0xffffffff810c685c in task_work_run () at kernel/task_work.c:113
#23 0xffffffff810029f2 in tracehook_notify_resume (regs=<optimized out>) at ./include/linux/tracehook.h:188
#24 exit_to_usermode_loop (regs=0xffff88806651ff58, cached_flags=0x2) at arch/x86/entry/common.c:167
#25 0xffffffff81003b60 in prepare_exit_to_usermode (regs=<optimized out>) at arch/x86/entry/common.c:198
#26 syscall_return_slowpath (regs=<optimized out>) at arch/x86/entry/common.c:271
#27 do_syscall_64 (nr=<optimized out>, regs=0xffff88806651ff58) at arch/x86/entry/common.c:296
#28 0xffffffff8240007c in entry_SYSCALL_64 () at arch/x86/entry/entry_64.S:175
#29 0x00007ffec3ef19f0 in ?? ()
#30 0x00005586c86ed260 in ?? ()
```
